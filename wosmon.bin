RESET:          CLD
CLI
LDY #$7F
STY DSP
LDA #$A7
STA KBDCR
STA DSPCR
NOTCR:          CMP #'_'+$80
BEQ BACKSPACE
CMP #$9B
BEQ ESCAPE
INY
BPL NEXTCHAR
ESCAPE:         LDA #'\\'+$80
JSR ECHO
GETLINE:        LDA #$8D
JSR ECHO
LDY #$01
BACKSPACE:      DEY
BMI GETLINE
NEXTCHAR:       LDA KBDCR
BPL NEXTCHAR
LDA KBD
STA IN,Y
JSR ECHO
CMP #$8D
BNE NOTCR
LDY #$FF
LDA #$00
TAX
SETSTOR:        ASL
SETMODE:        STA MODE
BLSKIP:         INY
NEXTITEM:       LDA IN,Y
CMP #$8D
BEQ GETLINE
CMP #'.'+$80
BCC BLSKIP
BEQ SETMODE
CMP #':'+$80
BEQ SETSTOR
CMP #'R'+$80
BEQ RUN
STX L
STX H
STY YSAV
NEXTHEX:        LDA IN,Y
EOR #$B0
CMP #$0A
BCC DIG
ADC #$88
CMP #$FA
BCC NOTHEX
DIG:            ASL
ASL
ASL
ASL
LDX #$04
HEXSHIFT:       ASL
ROL L
ROL H
DEX
BNE HEXSHIFT
INY
BNE NEXTHEX
NOTHEX:         CPY YSAV
BEQ ESCAPE
BIT MODE
BVC NOTSTOR
LDA L
STA (STL,X)
INC STL
BNE NEXTITEM
INC STH
TONEXTITEM:     JMP NEXTITEM
RUN:            JMP (XAML)
NOTSTOR:        BMI XAMNEXT
LDX #$02
SETADR:         LDA L-1,X
STA STL-1,X
STA XAML-1,X
DEX
BNE SETADR
NXTPRNT:        BNE PRDATA
LDA #$8D
JSR ECHO
LDA XAMH
JSR PRBYTE
LDA XAML
JSR PRBYTE
LDA #':'+$80
JSR ECHO
PRDATA:         LDA #$A0
JSR ECHO
LDA (XAML,X)
JSR PRBYTE
XAMNEXT:        STX MODE
LDA XAML
CMP L
LDA XAMH
SBC H
BCS TONEXTITEM
INC XAML
BNE MOD8CHK
INC XAMH
MOD8CHK:        LDA XAML
AND #$07
BPL NXTPRNT
PRBYTE:         PHA
LSR
LSR
LSR
LSR
JSR PRHEX
PLA
PRHEX:          AND #$0F
ORA #'0'+$80
CMP #$BA
BCC ECHO
ADC #$06
ECHO:           BIT DSP
BMI ECHO
STA DSP
RTS
BRK
BRK
.WORD $0F00
.WORD RESET
.WORD $0000